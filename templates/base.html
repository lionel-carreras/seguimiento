<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>{% block title %}Seguimiento Brio{% endblock %}</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="/static/css/tracking.css" rel="stylesheet">
<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#0d6efd"/>
<link rel="apple-touch-icon" href="/static/img/icons/icon-192.png">
</head>
<body class="bg-light d-flex flex-column min-vh-100">

{%include 'partials/navbar.html'%}


<main class="container py-4 flex-grow-1">
{% block content %}{% endblock %}
</main>

{%include 'partials/footer.html'%}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(() => {
  const btn = document.getElementById('btn-install-pwa');
  if (!btn) return;

  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || navigator.standalone === true;

  // Si ya está instalada, ocultamos
  if (isStandalone) {
    btn.classList.add('d-none');
    return;
  }

  // Guardamos el evento para lanzar el prompt cuando el usuario haga click
  let deferredPrompt = null;

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    btn.disabled = false;
    btn.classList.remove('d-none');
  });

  // iOS no dispara beforeinstallprompt: mostramos el botón y damos instrucciones
  if (isIOS) {
    btn.disabled = false;
    btn.classList.remove('d-none');
  } else {
    // Si a los 3s no hubo beforeinstallprompt (no elegible), ocultamos
    setTimeout(() => {
      if (!deferredPrompt) btn.classList.add('d-none');
    }, 3000);
  }

  btn.addEventListener('click', async () => {
    // Caso navegadores compatibles (Chrome/Edge/Android)
    if (deferredPrompt) {
      deferredPrompt.prompt();
      try {
        const { outcome } = await deferredPrompt.userChoice;
        // console.log('User choice:', outcome); // 'accepted' | 'dismissed'
      } finally {
        deferredPrompt = null;
        btn.disabled = true; // evitar doble click
      }
      return;
    }

    // Caso iOS (instrucciones)
    if (isIOS) {
      // Podés cambiar este alert por un modal bonito de Bootstrap
      alert('Para instalar en iPhone/iPad: tocá el botón “Compartir” (icono de cuadrado con flecha) y luego “Agregar a pantalla de inicio”.');
      return;
    }

    // Sin soporte
    alert('La instalación PWA no está disponible en este navegador.');
  });

  // Cuando la app queda instalada
  window.addEventListener('appinstalled', () => {
    // Podés mostrar un toast si querés
    btn.classList.add('d-none');
  });
})();


// helper base64url -> Uint8Array
function b64uToBytes(b64u){const pad='='.repeat((4-b64u.length%4)%4);
  const b64=(b64u+pad).replace(/-/g,'+').replace(/_/g,'/');
  return Uint8Array.from(atob(b64), c=>c.charCodeAt(0));
}

async function enablePush(envioId) {
  const reg = await navigator.serviceWorker.ready;
  // Tu backend devuelve la VAPID PUBLIC KEY del hub
  const vapidPub = await (await fetch('/api/push/vapid-public')).text();
  const sub = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: b64uToBytes(vapidPub)
  });
  // Enviá al server para crear/actualizar la Installation en ANH
  await fetch('/api/push/subscribe', {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ subscription: sub, tags: [`envio:${envioId}`] })
  });
  alert('Notificaciones activadas');
}
</script>

</body>
</html>
